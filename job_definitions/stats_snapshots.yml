{% set environments = ['preview', 'production'] %}
{% set frameworks = [('digital-outcomes-and-specialists-3', 'true')] %}
---
{% for environment in environments %}
{% for framework, disabled in frameworks %}
- job:
    name: 'snapshot-stats-{{ framework }}-{{ environment }}'
    disabled: {{ disabled }}
    display-name: "Snapshot {{ framework }} stats - {{ environment }}"
    project-type: freestyle
    description: Creates an hourly snapshot of framework stats and stores it in the API audit event
{% if environment != 'production' %}
    properties:
      - lockable-resources:
          resources: '{{ environment }}-database'
{% endif %}
    logrotate:
      daysToKeep: 20
      artifactDaysToKeep: 20
    triggers:
      - timed: "H * * * *"
    publishers:
      - trigger-parameterized-builds:
          - project: notify-slack
            condition: UNSTABLE_OR_WORSE
            predefined-parameters: |
              USERNAME=snapshot-stats
              JOB=Snapshot {{ framework }} stats {{ environment }}
              ICON=:alarm_clock:
              STAGE={{ environment }}
              STATUS=FAILED
              URL=<${BUILD_URL}consoleFull|#${BUILD_NUMBER}>
              CHANNEL=#dm-release
    builders:
      - shell: |
          docker run -e DM_DATA_API_TOKEN_{{ environment|upper }} digitalmarketplace/scripts scripts/snapshot-framework-stats.py "{{ framework }}" "{{ environment }}"
{% endfor %}
{% endfor %}
