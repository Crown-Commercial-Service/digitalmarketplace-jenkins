{% for environment in ['preview', 'staging', 'production'] %}
- job:
    name: "update-briefs-index-{{ environment }}"
    display-name: "Index briefs - {{ environment }}"
    project-type: freestyle
    description: "Update the {{ environment }} briefs index with briefs in the {{ environment }} database."
    triggers:
      - timed: "H 3 * * *"
    publishers:
      - trigger-parameterized-builds:
          - project: notify-slack
            condition: UNSTABLE_OR_WORSE
            predefined-parameters: |
              USERNAME=index-briefs
              JOB=Index briefs {{ environment }} :jenkins_parrot:
              ICON=:alarm_clock:
              STAGE={{ environment }}
              STATUS=FAILED
              URL=<${BUILD_URL}consoleFull|#${BUILD_NUMBER}>
              CHANNEL=#dm-release
    builders:
      - trigger-builds:
        - project: update-index-{{ environment }}
          predefined-parameters: |
            OBJECTS=briefs
            INDEX={{ search_config['briefs'].default_index }}
            FRAMEWORKS={{ search_config['briefs'].frameworks }}

      - shell: |
          docker run -e DM_DATA_API_TOKEN_{{ environment|upper }} -e DM_SEARCH_API_TOKEN_{{ environment|upper }} digitalmarketplace/scripts scripts/index-to-search-service.py briefs '{{ environment }}' --serial --index="{{ search_config['briefs'].default_index }}" --frameworks="{{ search_config['briefs'].frameworks }}"
{% endfor %}
