- job:
    name: database-backup
    display-name: Create offsite backup of database
    project-type: pipeline
    description: Takes a dump of the database, compresses it, encrypts it and uploads to S3.
    disabled: false
    concurrent: false
    triggers:
      - timed: "0 3 * * *"
    parameters:
      - extended-choice:
          name: STAGE
          type: radio
          default-value: preview
          value: preview,staging,production
    pipeline:
      script: |

        def notify_slack(icon, status) {
          build job: "notify-slack",
                parameters: [
                  string(name: 'USERNAME', value: "database-backup"),
                  string(name: 'ICON', value: icon),
                  string(name: 'JOB', value: "Backup ${STAGE} database to S3"),
                  string(name: 'CHANNEL', value: "#dm-release"),
                  text(name: 'STAGE', value: "${STAGE}"),
                  text(name: 'STATUS', value: status),
                  text(name: 'URL', value: "<${BUILD_URL}consoleFull|${BUILD_DISPLAY_NAME}>")
                ]
        }

        node {
          withEnv(["DM_CREDENTIALS_REPO=/var/lib/jenkins/digitalmarketplace-credentials", "CF_HOME=${pwd()}", "STAGE=${STAGE}"]) {
            try {
              git url: 'git@github.com:alphagov/digitalmarketplace-aws.git', branch: 'db_backups_from_live_db', credentialsId: 'github_com_and_enterprise'

              stage('Prepare') {
                build job: "update-credentials"
              }

              stage('Login to Cloud Foundry') {
                paas_credentials = sh(script: '$DM_CREDENTIALS_REPO/sops-wrapper -d $DM_CREDENTIALS_REPO/jenkins-vars/paas_credentials_env.enc', returnStdout: true).trim()
                withEnv(paas_credentials.tokenize("\n")) {
                  sh('make paas-login')
                }
              }

              stage('Connect to service, create dump and upload to S3') {
                sh('''
                  [ -d venv ] || virtualenv venv
                  . ./venv/bin/activate
                  pip install -r requirements.txt
                  make ${STAGE} deploy-db-backup-app
                ''')
                timeout(10) {
                  waitUntil {
                    sleep 5
                    def taskStatus = sh(
                        script: 'make check-db-backup-task',
                        returnStdout: true
                    ).trim()
                    echo "Task status is ${taskStatus}"
                    if (taskStatus == 'FAILED') {
                        sh("cf logs --recent db-backup")
                        throw new Exception('Create db dump task failed')
                    }
                    return (taskStatus == 'SUCCEEDED');
                  }
                  notify_slack(':file_cabinet:', 'SUCCESS')
                }
              }
            } catch(err) {
                notify_slack(':-1:', 'FAILURE')
                echo "Error caught"
                currentBuild.result = 'FAILURE'
                echo "Error: ${err}"
            } finally {
              stage('Cleanup') {
                sh('make cleanup-db-backup')
                sh('make paas-clean')
              }
            }
          }
        }
