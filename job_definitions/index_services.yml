{% set environments = [('preview', 'g-cloud-9'), ('staging', 'g-cloud-9'), ('production', 'g-cloud-9')] %}
---
{% for environment, frameworks in environments %}
- job:
    name: "index-services-{{ environment }}"
    display-name: "Index services - {{ environment }}"
    project-type: freestyle
    description: "This imports all services in the current API database into the current Elasticsearch index."
    parameters:
      - string:
          name: INDEX
          default: g-cloud
          description: "Index name to use (eg 'g-cloud-2017-05-22')"
      - string:
          name: FRAMEWORKS
          default: {{ frameworks }}
          description: "Comma-separated list of framework slugs that should be indexed (eg 'g-cloud-7,g-cloud-8'). If no frameworks are specified then all currently published services will be indexed."
    scm:
      - git:
          url: git@github.com:alphagov/digitalmarketplace-scripts.git
          credentials-id: github_com_and_enterprise
          branches:
            - master
          wipe-workspace: false
    triggers:
      - timed: "H 2 * * *"
    publishers:
      - trigger-parameterized-builds:
          - project: notify-slack
            condition: UNSTABLE_OR_WORSE
            predefined-parameters: |
              USERNAME=index-services
              JOB=Index services {{ environment }}
              ICON=:alarm_clock:
              STAGE={{ environment }}
              STATUS=FAILED
              URL=<${BUILD_URL}consoleFull|#${BUILD_NUMBER}>
              CHANNEL=#dm-release
    builders:
      - shell: |
          [ -d venv ] || virtualenv venv

          . ./venv/bin/activate
          pip install -r requirements.txt

          ./scripts/index-services.py '{{ environment }}' --search-api-token="$DM_SEARCH_API_TOKEN_{{ environment|upper }}" --api-token="$DM_DATA_API_TOKEN_{{ environment|upper }}" --serial --index="${INDEX}" --frameworks="${FRAMEWORKS}"
{% endfor %}
