- job:
    name: tag-release-and-build-image
    display-name: Tag release and build docker image
    project-type: pipeline
    description: Tag a repo with the current merge commit number and build its Docker image
    concurrent: true
    parameters:
      - choice:
          name: REPOSITORY
          choices:
{% for application in dm_applications %}
            - {{ application }}
{% endfor %}
            - scripts
            - manual
    dsl: |
      def tag_release(tag) {
        try {
          sh("git config user.name 'Jenkins'")
          sh("git config user.email '{{ jenkins_github_email }}'")
          sh("git tag -a ${tag} -m ${tag}")
          sh("git push origin ${tag} -f")
        } catch(e) {
          echo "${tag} tag already exists"
        }
      }

      stage('Create release tag') {
        node {
          git url: "git@github.com:alphagov/digitalmarketplace-${REPOSITORY}.git",
              branch: 'master', credentialsId: 'github_com_and_enterprise', poll: true
          releaseNumber = sh(
              script: "git log -1 --pretty=%B | grep 'Merge pull request' | cut -d ' ' -f 4 | tr -cd '[[:digit:]]'",
              returnStdout: true
          ).trim()

          if (releaseNumber == "") {
              throw new Exception('Release number can not be found')
          }

          releaseName = "release-${releaseNumber}"

          tag_release(releaseName)

          echo "Release number: ${releaseNumber}"
          currentBuild.displayName = "#${BUILD_NUMBER} - ${releaseName}"
        }
      }

      stage('Build') {
        node {
          build job: "build-image", parameters: [
            string(name: "REPOSITORY", value: "${REPOSITORY}"),
            string(name: "RELEASE_NAME", value: "${releaseName}"),
          ]
        }
      }
