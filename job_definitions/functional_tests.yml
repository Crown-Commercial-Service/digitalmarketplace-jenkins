{% set jobs = [
  {"name": "preview", "display_name": "preview",
   "description": "Run the full functional test suite against the preview environment",
   "tags": ["~@ssp-gcloud", "~@ssp-dos", "@functional-test"],
   "disabled": "false",
  },
  {"name": "ssp-preview", "display_name": "SSP preview",
   "description": "Run the SSP functional test suite against the preview environment",
   "tags": ["@ssp-gcloud"],
   "disabled": "true",
  }
] %}
---
{% for job in jobs %}
- job:
    name: "functional-tests-{{ job.name }}"
    disabled: {{ job.disabled }}
    display-name: "Functional tests - {{ job.display_name }}"
    project-type: freestyle
    description: "{{ job.description }}"
    logrotate:
      daysToKeep: 4
      artifactDaysToKeep: 4
    scm:
      - git:
          url: git@github.com:alphagov/digitalmarketplace-functional-tests.git
          credentials-id: github_com_and_gds
          branches:
            - jenkins
          wipe-workspace: false
    triggers:
      - timed: "H/30 * * * *"
      - pollscm: "H/2 * * * *"
    wrappers:
      - ansicolor
    publishers:
      - html-publisher:
          name: "functional test report"
          dir: reports
          files: index.html
          keep-all: true
          allow-missing: true
          link-to-last-build: true
      - trigger-parameterized-builds:
          - project: notify-slack
            condition: UNSTABLE_OR_WORSE
            predefined-parameters: |
              USERNAME=functional-tests
              JOB=Functional tests - {{ job.display_name }}
              ICON=:fire:
              STAGE=preview
              STATUS=FAILED
              URL=<${BUILD_URL}functional_test_report|${BUILD_DISPLAY_NAME}>
              CHANNEL=#dm-release
    builders:
      - shell: |
          rbenv install -s
          which bundler || gem install bundler
          bundle install
          
          export DM_API_ACCESS_TOKEN="$DM_DATA_API_TOKEN_PREVIEW"
          export DM_SEARCH_API_ACCESS_TOKEN="$DM_SEARCH_API_TOKEN_PREVIEW"

          export DM_API_DOMAIN="{{ app_urls.preview.data_api }}"
          export DM_SEARCH_API_DOMAIN="{{ app_urls.preview.search_api }}"
          export DM_FRONTEND_DOMAIN="{{ app_urls.preview.www }}"

          export DM_ADMIN_EMAIL="{{ functional_test_variables.preview.admin_email }}"
          export DM_ADMIN_CCS_SOURCING_EMAIL="{{ functional_test_variables.preview.admin_ccs_sourcing_email }}"
          export DM_ADMIN_CCS_CATEGORY_EMAIL="{{ functional_test_variables.preview.admin_ccs_category_email }}"
          export DM_ADMIN_PASSWORD="{{ functional_test_variables.preview.admin_password }}"
          export DM_BUYER_EMAIL="{{ functional_test_variables.preview.buyer_email }}"
          export DM_BUYER_PASSWORD="{{ functional_test_variables.preview.buyer_password }}"
          export DM_SUPPLIER_EMAIL="{{ functional_test_variables.preview.supplier_email }}"
          export DM_SUPPLIER2_EMAIL="{{ functional_test_variables.preview.supplier2_email }}"
          export DM_SUPPLIER3_EMAIL="{{ functional_test_variables.preview.supplier3_email }}"
          export DM_SUPPLIER_PASSWORD="{{ functional_test_variables.preview.supplier_password }}"

          mkdir -p reports
          rm -f screenshot*

          bundle exec cucumber features --tags ~@wip {% for tag in job.tags %} --tags {{ tag }} {% endfor %} --color --format html --out reports/index.html --format pretty
      - conditional-step:
          condition-kind: build-cause
          cause: UPSTREAM_CAUSE
          steps:
              - trigger-builds:
                - project: notify-slack
                  predefined-parameters: |
                    USERNAME=functional-tests
                    JOB=Functional tests - {{ job.display_name }}
                    ICON=:green_heart:
                    STAGE=preview
                    STATUS=SUCCESS
                    URL=<${BUILD_URL}consoleFull|${BUILD_DISPLAY_NAME}>
                    CHANNEL=#dm-release
{% endfor %}
