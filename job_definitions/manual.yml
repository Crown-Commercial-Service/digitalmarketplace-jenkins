---
- job:
    name: 'publish-manual'
    display: "Publish manual"
    project-type: freestyle
    description: "Automatically publish digitalmarketplace manual to gh pages."
    scm:
      - git:
          url: git@github.com:alphagov/digitalmarketplace-manual.git
          credentials-id: github_com_and_enterprise
          branches:
            - master
    triggers:
      - pollscm:
          cron: "H/2 * * * *"
    builders:
      - shell: |
          docker pull digitalmarketplace/manual || true
          docker build --pull -t digitalmarketplace/manual .
          docker push digitalmarketplace/manual

          DOCKER_UID="$(id -u)"
          DOCKER_GID="$(getent group docker | awk -F ':' '{print $3}')"

          docker run --rm \
            -u $DOCKER_UID:$DOCKER_GID \
            -v $(pwd):/app \
            digitalmarketplace/manual \
            make clean html

          make pages
