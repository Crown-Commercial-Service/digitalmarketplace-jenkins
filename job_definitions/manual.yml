---
- job:
    name: 'publish-manual'
    display: "Publish manual"
    project-type: pipeline
    description: "Automatically publish digitalmarketplace manual to gh pages."
    scm:
      - git:
          url: git@github.com:alphagov/digitalmarketplace-manual.git
          credentials-id: github_com_and_enterprise
          branches:
            - master
    triggers:
      - pollscm:
          cron: "H/2 * * * *"
    dsl: |
      node {
        stage('Prepare') {
          sh("git config user.name 'Jenkins'")
          sh("git config user.email '{{ jenkins_github_email }}'")
          git url: "git@github.com:alphagov/digitalmarketplace-manual.git", branch: 'master', credentialsId: 'github_com_and_enterprise', poll: true
        }

        stage('Build') {
          build job: "tag-release-and-build-image", parameters: [
            string(name: "REPOSITORY", value: "manual")
          ]
        }

        stage('Make HTML') {
          script {
            env.DOCKER_UID = sh(script:"id -u", returnStdout: true).trim()
            env.DOCKER_GID = sh(script:"getent group docker | awk -F ':' '{print \$3}'", returnStdout: true).trim()

            sh(script:"docker run --rm -u ${env.DOCKER_UID}:${env.DOCKER_GID} -v \$(pwd):/app digitalmarketplace/manual make clean html")
          }
        }

        stage('Push pages') {
          sh("make pages")
        }
      }