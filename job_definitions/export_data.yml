{% set environments = ['preview', 'production'] %}
---
{% for environment in environments %}
- job:
    name: "export-data-{{ environment }}"
    display-name: "Export API model data as CSV - {{ environment }}"
    project-type: freestyle
    description: "Runs the get-model-data.py script and uploads the generated CSV files to Google Drive (everything, for us) and S3 (just the opportunity data, for the public)"
    triggers:
      - timed: "H 5 * * *"
    publishers:
      - trigger-parameterized-builds:
          - project: notify-slack
            condition: UNSTABLE_OR_WORSE
            predefined-parameters: |
              USERNAME=export-data
              JOB=Export data {{ environment }}
              ICON=:foi:
              STAGE={{ environment }}
              STATUS=FAILED
              URL=<${BUILD_URL}consoleFull|#${BUILD_NUMBER}>
              CHANNEL=#dm-2ndline
    builders:
      - shell: |

          # We need to recreate the directory manually since the one created by Docker
          # when mounting the volume will otherwise be owned by the root user.
          rm -rf ./data && mkdir data

          docker run -e DM_DATA_API_TOKEN_{{ environment|upper }} --user $(id -u) --volume $(pwd)/data:/app/data digitalmarketplace/scripts scripts/get-model-data.py '{{ environment }}'
          docker run -e DM_DATA_API_TOKEN_{{ environment|upper }} --user $(id -u) --volume $(pwd)/data:/app/data digitalmarketplace/scripts scripts/upload-file-to-s3.py data/opportunity-data.csv digitalmarketplace-communications-{{ environment }}-{{ environment }} digital-outcomes-and-specialists-3/communications/data/opportunity-data.csv opportunity-data.csv --public

          {% if environment == "production" %}
          /usr/local/bin/gdrive --config "/var/lib/jenkins/.gdrive" sync upload --delete-extraneous ./data "{{ jenkins_gdrive_csv_data_export_folder_id }}"
          {% endif %}

{% endfor %}
