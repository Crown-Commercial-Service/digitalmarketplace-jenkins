{% set environments = ['preview', 'staging', 'production'] %}
---
{% for environment in environments %}
- job:
    name: "publish-g-cloud-services-{{ environment }}"
    display-name: "Publish G-Cloud services - {{ environment }}"
    project-type: freestyle
    description: "This publishes G-Cloud services by promoting them from draft to live, and copying associated documents into the approriate S3 bucket."
    parameters:
      - string:
          name: FRAMEWORK
          description: "Framework for filtering the services to publish."
    scm:
      - git:
          url: git@github.com:alphagov/digitalmarketplace-scripts.git
          credentials-id: github_com_and_enterprise
          branches:
            - master
          wipe-workspace: false
    publishers:
      - trigger-parameterized-builds:
          - project: notify-slack
            condition: UNSTABLE_OR_WORSE
            predefined-parameters: |
              USERNAME=make-g-cloud-live.py
              JOB=Publish G-Cloud services - {{ environment }}
              ICON=:alarm_clock:
              STAGE={{ environment }}
              STATUS=FAILED
              URL=<${BUILD_URL}consoleFull|#${BUILD_NUMBER}>
              CHANNEL=#dm-release
    builders:
      - shell: |
          [ -d venv ] || virtualenv venv

          . ./venv/bin/activate
          pip install -r requirements.txt

          AWS_PROFILE="{{ environment }}" python ./scripts/make-g-cloud-live.py $FRAMEWORK "{{ environment }}" $DM_DATA_API_TOKEN_{{ environment|upper }} digitalmarketplace-submissions-production-production digitalmarketplace-documents-{{ environment }}-{{ environment }}
{% endfor %}
