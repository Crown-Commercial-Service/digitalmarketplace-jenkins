{% set environments = ['preview', 'staging', 'production'] %}
---
{% for environment in environments %}
- job:
    name: "apps-are-up-{{ environment }}"
    display-name: "Apps are up - {{ environment }}"
    project-type: freestyle
    description: |
      Check that the five Digital Marketplace apps are up and running in the {{ environment|upper }} environment:
      <ul>
        <li>API</li>
        <li>Search API</li>
        <li>Buyer frontend</li>
        <li>Supplier frontend</li>
        <li>Admin frontend</li>
      </ul>
    logrotate:
      daysToKeep: 4
      artifactDaysToKeep: 4
    scm:
      - git:
          url: git@github.com:alphagov/digitalmarketplace-functional-tests.git
          credentials-id: github_com_and_gds
          branches:
            - master
          wipe-workspace: false
    triggers:
      - timed: "H/5 * * * *"
    wrappers:
      - ansicolor
    publishers:
      - html-publisher:
          name: "smoke test report"
          dir: reports
          files: index.html
          keep-all: true
          allow-missing: true
          link-to-last-build: true
      - trigger-parameterized-builds:
          - project: notify-slack
            condition: UNSTABLE_OR_WORSE
            predefined-parameters: |
              USERNAME=smoke-tests
              JOB=Apps are up - {{ environment }}
              ICON=:fire:
              STAGE={{ environment }}
              STATUS=FAILED
              URL=<${BUILD_URL}smoke_test_report|${BUILD_DISPLAY_NAME}>
              CHANNEL=#dm-release
    builders:
      - shell: |
          rbenv install -s
          gem install bundler

          export DM_API_DOMAIN="{{ app_urls[environment].data_api }}"
          export DM_API_ACCESS_TOKEN="$DM_DATA_API_TOKEN_{{ environment|upper }}"

          export DM_SEARCH_API_DOMAIN="{{ app_urls[environment].search_api }}"
          export DM_SEARCH_API_ACCESS_TOKEN="$DM_SEARCH_API_TOKEN_{{ environment|upper }}"

          export DM_FRONTEND_DOMAIN="{{ app_urls[environment].www }}"

          export DM_PRODUCTION_SUPPLIER_USER_EMAIL="{{ smoke_test_variables[environment].supplier_email }}"
          export DM_PRODUCTION_SUPPLIER_USER_PASSWORD="{{ smoke_test_variables[environment].supplier_password }}"
          export DM_PRODUCTION_SUPPLIER_USER_SUPPLIER_ID="{{ smoke_test_variables[environment].supplier_id }}"

          export DM_PRODUCTION_BUYER_USER_EMAIL="{{ smoke_test_variables[environment].buyer_email }}"
          export DM_PRODUCTION_BUYER_USER_PASSWORD="{{ smoke_test_variables[environment].buyer_password }}"

          export DM_PRODUCTION_ADMIN_USER_EMAIL="{{ smoke_test_variables[environment].admin_email }}"
          export DM_PRODUCTION_ADMIN_USER_PASSWORD="{{ smoke_test_variables[environment].admin_password }}"

          export DM_PRODUCTION_ADMIN_CCS_CATEGORY_USER_EMAIL="{{ smoke_test_variables[environment].admin_ccs_category_email }}"
          export DM_PRODUCTION_ADMIN_CCS_CATEGORY_USER_PASSWORD="{{ smoke_test_variables[environment].admin_ccs_category_password }}"

          export DM_PRODUCTION_ADMIN_CCS_SOURCING_USER_EMAIL="{{ smoke_test_variables[environment].admin_ccs_sourcing_email }}"
          export DM_PRODUCTION_ADMIN_CCS_SOURCING_USER_PASSWORD="{{ smoke_test_variables[environment].admin_ccs_sourcing_password }}"

          export DM_PAGINATION_LIMIT=100

          make setup

          bundle exec cucumber features --tags @smoke-tests features/apps_status.feature features
      - conditional-step:
          condition-kind: build-cause
          cause: UPSTREAM_CAUSE
          steps:
              - trigger-builds:
                - project: notify-slack
                  predefined-parameters: |
                    USERNAME=smoke-tests
                    JOB=Apps are up - {{ environment }}
                    ICON=:green_heart:
                    STAGE={{ environment }}
                    STATUS=SUCCESS
                    URL=<${BUILD_URL}consoleFull|${BUILD_DISPLAY_NAME}>
                    CHANNEL=#dm-release
{% endfor %}
