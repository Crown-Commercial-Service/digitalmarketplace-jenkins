{% for environment in ['preview', 'staging', 'production'] %}
- job:
    name: "update-{{ environment }}-index-alias"
    display-name: "Update {{ environment }} index alias"
    description: Apply a given alias to a given elasticsearch index
{% if environment != 'production' %}
    properties:
      - lockable-resources:
          resources: '{{ environment }}-database'
{% endif %}
    project-type: pipeline
    concurrent: false
    parameters:
      - string:
          name: ALIAS
          default:
          description: "The name of the alias you're applying."
      - string:
          name: TARGET
          description: >
            The name of the index you're applying the alias to, e.g.
            '{{search_config['briefs'][environment].default_index}}' or
            '{{search_config['services'][environment].default_index}}'.
      - extended-choice:
          name: DELETE_OLD_INDEX
          type: radio
          default: no
          value: yes,no
          description: "Delete the index that's losing the '<alias>-old' alias"
    pipeline:
      script: |
        node {
          withEnv(["DM_CREDENTIALS_REPO=/var/lib/jenkins/digitalmarketplace-credentials"]){
            stage('Update alias'){
              git url: 'git@github.com:alphagov/digitalmarketplace-scripts.git', branch: 'master', credentialsId: 'github_com_and_enterprise'
              sh('''
                VIRTUALENV_ROOT=$([ -z ${VIRTUAL_ENV} ] && echo $(pwd)/venv || echo ${VIRTUAL_ENV})
                [ -z "${VIRTUAL_ENV}" ] && [ ! -d venv ] && virtualenv venv || true
                source ${VIRTUALENV_ROOT}/bin/activate
                ${VIRTUALENV_ROOT}/bin/pip install -r requirements.txt

                docker run -e "DM_SEARCH_API_TOKEN_{{ environment|upper }}" -e "DM_DATA_API_TOKEN_{{ environment|upper }}" digitalmarketplace/scripts scripts/update-index-alias.py "${ALIAS}" "${TARGET}" "{{ app_urls[environment].search_api }}" --stage="{{ environment }}" --delete-old-index=${DELETE_OLD_INDEX}
              ''')
            }
          }
        }
{% endfor %}
