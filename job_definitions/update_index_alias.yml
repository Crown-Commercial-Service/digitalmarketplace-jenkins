{% for environment in ['preview', 'staging', 'production'] %}
- job:
    name: "update-index-alias-{{ environment }}"
    display-name: "Update index alias - {{ environment }}"
    description: |
        Create an alias for a given elasticsearch index.
        If there is an index with that alias already then
        that index will be given the alias '<alias>-old'.

        Look at previous builds for example parameters.
    project-type: pipeline
    concurrent: false
    parameters:
      - string:
          name: ALIAS
          default:
          description: "The alias name, e.g. 'g-cloud-9'."
      - string:
          name: TARGET
          description: >
            The name of the index the alias will point to to, e.g.
            'g-cloud-9-2018-01-26'.
      - extended-choice:
          name: DELETE_OLD_INDEX
          type: radio
          default: no
          value: yes,no
          description: >
            If there is an index with the alias '<alias>-old' and
            this option is enabled then that index will be deleted.
    pipeline:
      script: |
        node {
          stage('Update alias'){
            sh('''
              docker run \
                -e "DM_SEARCH_API_TOKEN_{{ environment|upper }}" \
                -e "DM_DATA_API_TOKEN_{{ environment|upper }}" \
                digitalmarketplace/scripts \
                scripts/update-index-alias.py \
                "${ALIAS}" \
                "${TARGET}" \
                "{{ app_urls[environment].search_api }}" \
                --stage="{{ environment }}" \
                --delete-old-index=${DELETE_OLD_INDEX}
            ''')
          }
        }
{% endfor %}
