{% set environments = ['preview', 'production'] %}
---
{% for environment in environments %}
- job:
    name: "notify-suppliers-of-new-questions-answers-{{ environment }}"
    display-name: "Notify suppliers of new questions and answers - {{ environment }}"
    project-type: freestyle
    description: "Send email notifications to supplier users about new questions and answers."
    parameters:
      - string:
          name: EXCLUDE_SUPPLIER_IDS
          description: "List of supplier IDs to be excluded from the email notification"
      - bool:
          name: DRY_RUN
          default: false
          description: "List notifications that would be sent without sending the emails"
    scm:
      - git:
          url: git@github.com:alphagov/digitalmarketplace-scripts.git
          credentials-id: github_com_and_enterprise
          branches:
            - master
          wipe-workspace: false
    triggers:
      - timed: "0 8 * * *"
    publishers:
      - trigger-parameterized-builds:
          - project: notify-slack
            condition: UNSTABLE_OR_WORSE
            predefined-parameters: |
              USERNAME=notify-suppliers
              JOB=Notify suppliers of new questions answers {{ environment }}
              ICON=:alarm_clock:
              STAGE={{ environment }}
              STATUS=FAILED
              URL=<${BUILD_URL}consoleFull|#${BUILD_NUMBER}>
              CHANNEL=#dm-release
    builders:
      - shell: |
          [ -d venv ] || virtualenv venv

          . ./venv/bin/activate
          pip install -r requirements.txt

          if [ -n "EXCLUDE_SUPPLIER_IDS" ]; then
            FLAGS="--exclude-supplier-ids=$EXCLUDE_SUPPLIER_IDS"
          fi

          if [ "$DRY_RUN" = "true" ]; then
            FLAGS="$FLAGS --dry-run"
          fi

          ./scripts/notify-suppliers-of-new-questions-answers.py '{{ environment }}' --api-token="$DM_DATA_API_TOKEN_{{ environment|upper }}" --mandrill-api-key="$MANDRILL_API_KEY_{{ environment|upper }}" $FLAGS
{% endfor %}
