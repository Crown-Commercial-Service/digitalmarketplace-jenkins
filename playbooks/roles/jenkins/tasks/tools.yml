---
- name: Install tools
  apt: update_cache=true name={{ item }}
  with_items:
    - git
    - python-pip
    - python-virtualenv
    - libpq-dev
    - python-dev
    - phantomjs
    - libyaml-dev

- name: Install rbenv
  sudo: yes
  sudo_user: jenkins
  git: repo={{ item.repo }} dest=/var/lib/jenkins/{{ item.path }}
  with_items:
    - {repo: "https://github.com/sstephenson/rbenv.git", path: ".rbenv"}
    - {repo: "https://github.com/sstephenson/ruby-build.git", path: ".rbenv/plugins/ruby-build"}
    - {repo: "https://github.com/carsomyr/rbenv-bundler.git", path: ".rbenv/plugins/bundler"}

- name: Add .rbenv to PATH
  lineinfile: >
    dest=/var/lib/jenkins/.bash_profile
    create=yes
    regexp='^export PATH="$HOME/.rbenv/bin'
    line='export PATH="$HOME/.rbenv/bin:$PATH"'
    owner=jenkins
    group=jenkins

- name: Add rbenv init
  lineinfile: >
    dest=/var/lib/jenkins/.bash_profile
    regexp='rbenv init'
    line='eval "$(rbenv init -)"'
    owner=jenkins
    group=jenkins

- name: Add .aws config directory
  file: path=/var/lib/jenkins/.aws state=directory owner=jenkins group=jenkins

- name: Add AWS credentials file
  template: src=aws_credentials.j2 dest=/var/lib/jenkins/.aws/credentials

- name: Add NodeJS apt repository key
  apt_key:
    url: "https://deb.nodesource.com/gpgkey/nodesource.gpg.key"
    state: present

- name: Add NodeJS apt repository
  apt_repository:
    repo: "deb https://deb.nodesource.com/node_0.12 trusty main"
    state: present
    update_cache: yes

- name: Install NodeJS
  apt: pkg=nodejs state=installed
